<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–ê–ß–ò –ö–û–†–û ¬∑ –†–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            user-select: none;
        }
        body {
            background: #0b3050;
            padding: 12px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .game-wrapper {
            max-width: 1400px;
            width: 100%;
            background: #1d6390;
            border-radius: 40px;
            padding: 20px;
            border: 6px solid #8eccef;
        }
        .top-panel {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0c4060;
            border-radius: 50px;
            padding: 15px 20px;
            border: 4px solid #9fd3ff;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .dice-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .die {
            width: 60px;
            height: 60px;
            background: #edf7ff;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 800;
            box-shadow: 0 6px 0 #3c6990;
            color: #00263b;
        }
        .roll-btn {
            background: #50b0f0;
            border: none;
            font-size: 28px;
            font-weight: 700;
            padding: 10px 30px;
            border-radius: 50px;
            box-shadow: 0 6px 0 #1d66a0;
            cursor: pointer;
        }
        .roll-btn:disabled { opacity: 0.4; pointer-events: none; }
        .room-controls {
            display: flex;
            gap: 8px;
            background: #0b3b50;
            padding: 8px 15px;
            border-radius: 40px;
        }
        .room-input {
            background: white;
            border: none;
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 30px;
            width: 130px;
        }
        .join-btn {
            background: #3ea0dd;
            border: none;
            font-size: 18px;
            padding: 8px 16px;
            border-radius: 30px;
            color: white;
            cursor: pointer;
        }
        .status {
            background: #0b3b50;
            color: white;
            font-size: 18px;
            padding: 8px 20px;
            border-radius: 40px;
        }
        .turn-indicator {
            background: #1873a5;
            color: white;
            font-size: 24px;
            padding: 8px 20px;
            border-radius: 40px;
        }
        .main-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .player-board {
            flex: 1 1 280px;
            background: #156f9f;
            border-radius: 40px;
            padding: 15px;
            border: 5px solid #9fd3ff;
        }
        .player-header {
            display: flex;
            justify-content: space-between;
            background: #043d5c;
            color: white;
            font-size: 24px;
            padding: 12px 15px;
            border-radius: 30px;
            margin-bottom: 12px;
        }
        .coins {
            background: #fad461;
            color: #024059;
            padding: 5px 20px;
            border-radius: 40px;
        }
        .landmarks-wrap {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .landmark {
            background: #517e9e;
            border-radius: 25px;
            padding: 10px 5px;
            text-align: center;
            font-size: 16px;
            border: 3px solid #b8dfff;
            opacity: 0.7;
            cursor: pointer;
            color: white;
        }
        .landmark.built {
            opacity: 1;
            background: #f0bc40;
            color: #1b3d4f;
        }
        .player-enterprises {
            background: #0a547a;
            border-radius: 30px;
            padding: 12px;
            min-height: 120px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .market-grid {
            flex: 2 1 350px;
            background: #10658f;
            border-radius: 40px;
            padding: 15px;
            border: 5px solid #a3d6ff;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            aspect-ratio: 1/1;
            max-width: 450px;
        }
        .market-card {
            background: #eaf5ff;
            border-radius: 20px;
            padding: 8px 3px;
            border-left: 8px solid;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            text-align: center;
        }
        .market-card.green { border-left-color: #2e8b57; }
        .market-card.blue { border-left-color: #1e81d0; }
        .buy-btn-market {
            background: #2f8f74;
            border: none;
            color: white;
            font-size: 14px;
            padding: 4px 0;
            border-radius: 20px;
            width: 100%;
            margin-top: 4px;
        }
        .log-panel {
            background: #094368;
            border-radius: 50px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .log-text {
            background: #032b40;
            color: #d4f0ff;
            font-size: 18px;
            padding: 10px 25px;
            border-radius: 40px;
            flex: 1;
        }
        .reset-btn {
            background: #d6704a;
            color: white;
            font-size: 20px;
            padding: 8px 30px;
            border-radius: 40px;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <div class="top-panel">
        <div class="dice-area">
            <div class="die" id="die1">‚öÄ</div>
            <div class="die" id="die2">‚öÄ</div>
            <div class="die" id="diceSum" style="width: auto; padding:0 15px;">2</div>
        </div>
        <button class="roll-btn" id="rollBtn" disabled>üé≤ –ë–†–û–°–ò–¢–¨</button>
        <div class="room-controls">
            <input class="room-input" id="roomInput" value="game123" placeholder="–∫–æ–º–Ω–∞—Ç–∞">
            <button class="join-btn" id="joinBtn">üîó –í–û–ô–¢–ò</button>
        </div>
        <div class="status" id="status">–ù–µ –≤ —Å–µ—Ç–∏</div>
        <div class="turn-indicator" id="turnDisplay">–•–û–î 1</div>
    </div>

    <div class="main-row">
        <div class="player-board">
            <div class="player-header"><span>üë§ –ò–ì–†–û–ö 1</span><span class="coins" id="p1Coins">3ü™ô</span></div>
            <div class="landmarks-wrap" id="p1Landmarks"></div>
            <div class="player-enterprises" id="p1Enterprises"></div>
        </div>
        <div class="market-grid" id="marketGrid"></div>
        <div class="player-board">
            <div class="player-header"><span>üë§ –ò–ì–†–û–ö 2</span><span class="coins" id="p2Coins">3ü™ô</span></div>
            <div class="landmarks-wrap" id="p2Landmarks"></div>
            <div class="player-enterprises" id="p2Enterprises"></div>
        </div>
    </div>

    <div class="log-panel">
        <div class="log-text" id="gameMessage">üéØ –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏ –Ω–∞–∂–º–∏—Ç–µ –í–û–ô–¢–ò</div>
        <button class="reset-btn" id="resetGame">‚ü≤ –°–ë–†–û–°</button>
    </div>
</div>

<script>
    // ‚ö†Ô∏è –í–°–¢–ê–í–¨–¢–ï –°–í–û–ò –ö–õ–Æ–ß–ò FIREBASE –ó–î–ï–°–¨
    const firebaseConfig = {
  apiKey: "AIzaSyBd3A6Wz7NTCfj5bvAbARR2Jw4P5zE4hng",
  authDomain: "machi-d8f62.firebaseapp.com",
  databaseURL: "https://machi-d8f62-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "machi-d8f62",
  storageBucket: "machi-d8f62.firebasestorage.app",
  messagingSenderId: "681603724052",
  appId: "1:681603724052:web:1fdc4b655a657050968801",
  measurementId: "G-5X29V91F2J"
};

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    const connectedRef = firebase.database().ref(".info/connected");
    connectedRef.on("value", (snap) => {
        if (snap.val() === true) {
            document.getElementById('status').textContent = 'üü¢ –í —Å–µ—Ç–∏';
        } else {
            document.getElementById('status').textContent = 'üî¥ –û—Ñ–ª–∞–π–Ω';
        }
    });

    // ---------- –ö–ê–†–¢–´ ----------
    const ENTERPRISES = [
        { id: 'wheat', name: '–ü—à–µ–Ω–∏—Ü–∞', icon: 'üåæ', dice: [1], cost: 1, income: 1, color: 'green', target: 'any' },
        { id: 'ranch', name: '–†–∞–Ω—á–æ', icon: 'üêÑ', dice: [2], cost: 1, income: 1, color: 'green', target: 'any' },
        { id: 'bakery', name: '–ü–µ–∫–∞—Ä–Ω—è', icon: 'üçû', dice: [2,3], cost: 1, income: 1, color: 'blue', target: 'self' }
    ];

    const LANDMARKS = [
        { id: 'station', name: '–í–æ–∫–∑–∞–ª', icon: 'üöâ', cost: 4 },
        { id: 'mall', name: '–¢–¶', icon: 'üè¨', cost: 10 }
    ];

    // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç undefined
    const defaultState = {
        p1: { coins: 3, enterprises: ['wheat', 'bakery'], landmarks: [] },
        p2: { coins: 3, enterprises: ['wheat', 'bakery'], landmarks: [] },
        turn: 1,
        lastRoll: [1, 1],
        timestamp: Date.now()
    };

    let gameState = JSON.parse(JSON.stringify(defaultState)); // –ì–ª—É–±–æ–∫–∞—è –∫–æ–ø–∏—è
    let myPlayer = null;
    let roomRef = null;
    let marketSupply = { wheat: 6, ranch: 6, bakery: 6 };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const die1 = document.getElementById('die1');
    const die2 = document.getElementById('die2');
    const diceSumSpan = document.getElementById('diceSum');
    const rollBtn = document.getElementById('rollBtn');
    const turnDisplay = document.getElementById('turnDisplay');
    const gameMessage = document.getElementById('gameMessage');
    const joinBtn = document.getElementById('joinBtn');
    const roomInput = document.getElementById('roomInput');
    const resetBtn = document.getElementById('resetGame');
    const p1Coins = document.getElementById('p1Coins');
    const p2Coins = document.getElementById('p2Coins');
    const p1LandmarksDiv = document.getElementById('p1Landmarks');
    const p2LandmarksDiv = document.getElementById('p2Landmarks');
    const p1EntDiv = document.getElementById('p1Enterprises');
    const p2EntDiv = document.getElementById('p2Enterprises');
    const marketDiv = document.getElementById('marketGrid');

    function getCard(id) {
        return ENTERPRISES.find(c => c.id === id) || null;
    }

    function setMessage(msg) {
        gameMessage.textContent = 'üì£ ' + msg;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
    function pushState() {
        if (roomRef) {
            gameState.timestamp = Date.now();
            roomRef.set(gameState).catch(e => console.log('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:', e));
        }
    }

    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
    function updateUI() {
        if (!gameState) return;
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined
        const p1 = gameState.p1 || { coins: 0, enterprises: [], landmarks: [] };
        const p2 = gameState.p2 || { coins: 0, enterprises: [], landmarks: [] };
        
        p1Coins.textContent = (p1.coins || 0) + 'ü™ô';
        p2Coins.textContent = (p2.coins || 0) + 'ü™ô';

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –¥–ª—è –ò–≥—Ä–æ–∫–∞ 1
        let html1 = '';
        LANDMARKS.forEach(lm => {
            const built = p1.landmarks && p1.landmarks.includes(lm.id) ? 'built' : '';
            html1 += `<div class="landmark ${built}" data-landmark="${lm.id}" data-player="p1">${lm.icon} ${lm.name}<br>${lm.cost}ü™ô</div>`;
        });
        p1LandmarksDiv.innerHTML = html1;

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –¥–ª—è –ò–≥—Ä–æ–∫–∞ 2
        let html2 = '';
        LANDMARKS.forEach(lm => {
            const built = p2.landmarks && p2.landmarks.includes(lm.id) ? 'built' : '';
            html2 += `<div class="landmark ${built}" data-landmark="${lm.id}" data-player="p2">${lm.icon} ${lm.name}<br>${lm.cost}ü™ô</div>`;
        });
        p2LandmarksDiv.innerHTML = html2;

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –ò–≥—Ä–æ–∫–∞ 1
        let ent1 = '';
        (p1.enterprises || []).forEach(id => {
            const card = getCard(id);
            if (card) {
                ent1 += `<div class="mini-card ${card.color}">${card.icon} ${card.dice.join(',')}</div>`;
            }
        });
        p1EntDiv.innerHTML = ent1 || 'üÉè';

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –ò–≥—Ä–æ–∫–∞ 2
        let ent2 = '';
        (p2.enterprises || []).forEach(id => {
            const card = getCard(id);
            if (card) {
                ent2 += `<div class="mini-card ${card.color}">${card.icon} ${card.dice.join(',')}</div>`;
            }
        });
        p2EntDiv.innerHTML = ent2 || 'üÉè';

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä—ã–Ω–∫–∞
        let marketHtml = '';
        ENTERPRISES.forEach(card => {
            const p1c = (p1.enterprises || []).filter(id => id === card.id).length;
            const p2c = (p2.enterprises || []).filter(id => id === card.id).length;
            const available = marketSupply[card.id] > 0;
            const canBuy = myPlayer === gameState.turn && 
                          (gameState[`p${gameState.turn}`]?.coins || 0) >= card.cost && 
                          available;
            
            marketHtml += `<div class="market-card ${card.color}">
                <span>${card.icon}</span>
                <div>${card.dice.join(',')}</div>
                <div>${card.cost}ü™ô</div>
                <div>${p1c}/${p2c}</div>
                <button class="buy-btn-market" data-card="${card.id}" ${canBuy ? '' : 'disabled'}>–∫—É–ø–∏—Ç—å</button>
            </div>`;
        });
        marketDiv.innerHTML = marketHtml;

        // –ö—É–±–∏–∫–∏
        if (gameState.lastRoll) {
            die1.textContent = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][(gameState.lastRoll[0] || 1) - 1];
            die2.textContent = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][(gameState.lastRoll[1] || 1) - 1];
            diceSumSpan.textContent = (gameState.lastRoll[0] || 1) + (gameState.lastRoll[1] || 1);
        }
        
        turnDisplay.textContent = `–•–û–î ${gameState.turn || 1}`;
        rollBtn.disabled = (myPlayer !== gameState.turn);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        attachHandlers();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
    function attachHandlers() {
        document.querySelectorAll('.landmark').forEach(el => {
            el.onclick = () => {
                if (myPlayer !== gameState.turn) {
                    setMessage('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥');
                    return;
                }
                const pid = el.dataset.player;
                if (pid !== `p${gameState.turn}`) return;
                
                const lid = el.dataset.landmark;
                const player = gameState[pid];
                if (!player) return;
                
                if (player.landmarks && player.landmarks.includes(lid)) return;
                
                const lm = LANDMARKS.find(l => l.id === lid);
                if (!lm) return;
                
                if (player.coins < lm.cost) {
                    setMessage('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
                    return;
                }
                
                player.coins -= lm.cost;
                if (!player.landmarks) player.landmarks = [];
                player.landmarks.push(lid);
                setMessage(`–ü–æ—Å—Ç—Ä–æ–µ–Ω–æ: ${lm.name}`);
                pushState();
                updateUI();
            };
        });

        document.querySelectorAll('.buy-btn-market').forEach(btn => {
            btn.onclick = () => {
                if (myPlayer !== gameState.turn) {
                    setMessage('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥');
                    return;
                }
                
                const cid = btn.dataset.card;
                const card = getCard(cid);
                if (!card) return;
                
                const player = gameState[`p${gameState.turn}`];
                if (!player) return;
                
                if (player.coins < card.cost) {
                    setMessage('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
                    return;
                }
                
                if (marketSupply[cid] <= 0) {
                    setMessage('–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏');
                    return;
                }
                
                player.coins -= card.cost;
                if (!player.enterprises) player.enterprises = [];
                player.enterprises.push(cid);
                marketSupply[cid]--;
                setMessage(`–ö—É–ø–ª–µ–Ω–æ: ${card.name}`);
                pushState();
                updateUI();
            };
        });
    }

    // –î–æ—Ö–æ–¥ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
    function resolveIncome(activeNum, diceSum) {
        const active = `p${activeNum}`;
        const player = gameState[active];
        if (!player) return;
        
        // –ü—Ä–æ—Å—Ç–æ –¥–∞—ë–º 1 –º–æ–Ω–µ—Ç—É –∑–∞ —Ö–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∞
        player.coins = (player.coins || 0) + 1;
    }

    // –ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–æ–≤
    function rollDice() {
        if (myPlayer !== gameState.turn) return;
        
        const d1 = Math.floor(Math.random() * 6) + 1;
        const d2 = Math.floor(Math.random() * 6) + 1;
        const sum = d1 + d2;
        
        gameState.lastRoll = [d1, d2];
        resolveIncome(gameState.turn, sum);
        
        gameState.turn = gameState.turn === 1 ? 2 : 1;
        pushState();
        updateUI();
    }

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
    function joinRoom() {
        const roomId = roomInput.value.trim();
        if (!roomId) return;
        
        document.getElementById('status').textContent = 'üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
        roomRef = database.ref('games/' + roomId);
        
        roomRef.once('value').then(snap => {
            if (!snap.exists()) {
                myPlayer = 1;
                gameState = JSON.parse(JSON.stringify(defaultState));
                roomRef.set(gameState);
                document.getElementById('status').textContent = '‚úÖ –í—ã –ò–≥—Ä–æ–∫ 1';
            } else {
                myPlayer = 2;
                document.getElementById('status').textContent = '‚úÖ –í—ã –ò–≥—Ä–æ–∫ 2';
            }
            
            roomRef.on('value', snap => {
                if (snap.exists()) {
                    const data = snap.val();
                    if (data) {
                        gameState = data;
                        updateUI();
                    }
                }
            });
        }).catch(e => {
            console.log('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', e);
            document.getElementById('status').textContent = '‚ùå –û—à–∏–±–∫–∞';
        });
    }

    // –°–±—Ä–æ—Å –∏–≥—Ä—ã
    function resetGame() {
        gameState = JSON.parse(JSON.stringify(defaultState));
        marketSupply = { wheat: 6, ranch: 6, bakery: 6 };
        if (roomRef) {
            roomRef.set(gameState);
        }
        updateUI();
        setMessage('–ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    joinBtn.addEventListener('click', joinRoom);
    rollBtn.addEventListener('click', rollDice);
    resetBtn.addEventListener('click', resetGame);

    // –ù–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
    updateUI();
    setMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏ –Ω–∞–∂–º–∏—Ç–µ –í–û–ô–¢–ò');
</script>
</body>
</html>
